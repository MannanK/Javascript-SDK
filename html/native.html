<!DOCTYPE html>
<html>
<head>
</head>
<body>

<!--

init
  1. create active, preparing, and fading audio tags, and kick off
     playback.

init and prepare
  1. create active, preparing, and fading audio tags, and kick off
     playback.
  2. call prepare with URL

prepare:
  1. Stick new URL in preparing player and get browser to
     begin pre-loading. Assign time index to 0.

create
  1. If preparing has a matching url, then move that to active
     and assign the start time. Otherwise call prepare with the
     URL, then retry the create.

play
  1. Begin playback of active tag. Trigger an error if playback fails,
     otherwise trigger a 'playing' event.
 
pause
  1. Pause playback of active. 

.. end.. when the active song completes playback, emit a 'finish'

- play() throws an exception when the .src is swapped out before
  playback begins. If playback has begun already then we, instead,
  get an 'abort' event.

- when audio ends, we get a 'pause' event followed by an 'ended' event.
  We can consider the 'ended' to be the 'finish' event.

- when we swap out the src in an audio tag (prepare), we get 
  'emptied', and then 'timeupdate'. Eventually we get 'loadstart', 
  'durationchange', 'loadedmetadata', 'loadeddata', 'canplay', 'canplaythrough'
  'progress'. When the assignment is made, the currentTime is
  immediately reset to 0.

- re-assigning a URL to .src caused an abort/emptied set of events.

- the 'play' event doesn't mean actual audio playback - it just means that we're
  trying to play.

- when preparing a bad file, no errors are thrown

-->

<p>
  <button id="init">init</button><br/>
  <button id="initAndPrepare">initAndPrepare</button><br/>
  <button id="initAndDelayedPrepare">initAndDelayedPrepare</button><br/>
  <button id="prepare">prepare</button><br/>
  <button id="initCreatePlay">initCreatePlay</button><br/>
  <button id="initCreatePlayPause">initCreatePlayPause</button><br/>
  <button id="initCreatePlayDelayedPlay">initCreatePlayDelayedPlay</button><br/>
  <button id="createPlay">createPlay</button></br>
  <button id="createPlayAtOffset">createPlayAtOffset</button></br>
  <button id="create">create</button><br/>
  <button id="play">play</button><br/>
  <button id="pause">pause</button><br/>
</p>
<p>
  <ul>
    <li>
      <label><input type="radio" name="url" value="http://s3.amazonaws.com/feedfm-audio/1408925951-71958.m4a" checked="checked">short audio</label>
    </li><li>
      <label><input type="radio" name="url" value="https://dgase5ckewowv.cloudfront.net/feedfm-audio/1512685614-59837.mp3">good long audio</label><br/>
    </li><li>
      <label><input type="radio" name="url" value="http://google.com/">google</label><br/>
    </li><li>
      <label><input type="radio" name="url" value="http://s3.amazonaws.com/feedfm-audio/1408842300-22034.m4a">bad audio</label><br/>
    </li>
  </ul>
</p>
<p>
  <label><input type="radio" name="fadeout" value="0" checked="checked">0</label>
  <label><input type="radio" name="fadeout" value="2">2</label>
  <label><input type="radio" name="fadeout" value="5">5</label>
</p>

<h4>Events:</h4>
<ul id="events">
</ul>

<script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>

<script>

//var RELATIVE_SILENCE='../dist/latest/5seconds.mp3';
var SILENCE ='data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA';

function trigger(event) {
   $('#events').append('<li>' + (new Date()) + ': ' + event);
}

var active, preparing, fading;

var fade;

function updateFade() {
  fade = +$('input[name=fadeout]:checked').val();
  console.log('fade value updated to', fade);
}
updateFade();

$("input[name=fadeout]").on('click', function(e) {
  updateFade();
});


function d(audio) {
  return ' src = ' + audio.src + ', time = ' + audio.currentTime + ', paused = ' + audio.paused + ', duration = ' + audio.duration + ', readyState = ' + audio.readyState;
}

function addEventListeners(object) {
  var events = [ 'abort', 'load', 'loadend', 'loadstart', 'loadeddata', 'loadedmetadata', 'canplay', 'canplaythrough', 'seeked', 'seeking', 'stalled', 'timeupdate', 'volumechange', 'waiting', 'durationchange', 'progress', 'emptied', 'ended', 'play', 'pause'  ];

  for (var i = 0; i < events.length; i++) {
    object.addEventListener(events[i], function(event) {
      var audio = event.currentTarget;
      var name = (audio === active) ?    'active' :
                 (audio === preparing) ? 'preparing' :
                                         'fading';

      console.log(name + ': ' + event.type);
      console.log('    active: ' + d(active));
      console.log('    preparing: ' + d(preparing));
      console.log('    fading: ' + d(fading));

      if (audio.src === SILENCE) {
        return;
      }

      if (name === 'active') {
        if (event.type === 'play') {
          trigger('play');

        } else if (event.type === 'pause') {
          if (audio.currentTime !== audio.duration) {
            trigger('pause');
          }

        } else if (event.type === 'ended') {
          trigger('finish');

        } else if (event.type == 'timeupdate') {
          console.log('time at ' + audio.currentTime + ' going to ' + audio.duration);
          if (!isNaN(audio.duration) && (audio.duration - fade <= audio.currentTime)) {
            // time to start fading!
            beginFadeout();
          }

          var ranges = audio.buffered;
          console.log('buffered ends at ' + ranges.end(ranges.length - 1));
        }

      } else if (name === 'fading') {
        if (event.type === 'timeupdate') {
          adjustFadeoutVolume();

        } else if (event.type === 'ended') {
          resetFadeout();

        }
      }

    });
  }
}


function init() {
  console.log('initializing');

  active =  new Audio(SILENCE);
  //SILENCE=active.src;
  addEventListeners(active);
  active.loop = false;
  /*
  active.play()
    .catch(function(e) {
      // ok to ignore
      console.log('active player aborted silence load');
    });
    */

  preparing = new Audio(SILENCE);
  addEventListeners(preparing);
  preparing.loop = false;
  /*
  preparing.play()
    .catch(function(e) {
      // ok to ignore
      console.log('preparing player aborted silence load');
    });
    */

  fading = new Audio(SILENCE);
  addEventListeners(fading);
  fading.loop = false;
  /*
  fading.play()
    .catch(function(e) {
      // ok to ignore
      console.log('fading player aborted silence load');
    });
    */

  console.log('done with init');
};

function prepare() {
  var url = $('input[name=url]:checked').val();
  console.log('preparing ' + url);
  if (preparing.src != url) {
    preparing.src = url;
    console.log('right after assigning url, time is ' + preparing.currentTime);

  } else {
    console.log('not updating preparing.src since it matches');

  }
}

function adjustFadeoutVolume() {
  var remaining = fading.duration - fading.currentTime;
  var volumePercentage = remaining / fade;

  console.log('adjusting fade to ', volumePercentage);

  if (volumePercentage < 0) {
    fading.volume = 0;

  } else if (volumePercentage <= 1) {
    fading.volume = volumePercentage;

  } else {
    console.log('odd fade value', fading.duration, fading.currentTime, fade);
    fading.volume = 1;

  }
}

function resetFadeout() {
  fading.src = SILENCE;
}

function beginFadeout() {
  console.log('swapping active with fading');
  fading.src = SILENCE;

  var oldFading = fading;
  fading = active;
  active = oldFading;

  trigger('finished');

  adjustFadeoutVolume();
}

function create(offset) {
  console.log('creating');
  prepare();

  console.log('pausing active');
  // note no 'finish' is sent out 
  active.src = SILENCE;

  console.log('swapping');
  var oldActive = active;
  active = preparing;
  preparing = oldActive;

  if (offset) {
    active.currentTime = offset;
  }
}


function play() {
  console.log('playing');

  active.play()
    .then(function() {
      console.log('playback succeeded!');

    })
    .catch(function(err) {
      console.log('playback failed!');

      trigger('finish');

    });

  if ((fading.src !== null) && (fading.src !== SILENCE)) {
    fading.play()
      .catch(function(err) {
        // ignore
      });
  }
}

function initCreatePlay() {
  init();
  create();
  play();
}

function createPlay() {
  create();
  play();
}

$('#createPlay').on('click', function() {
  createPlay();
});

$('#createPlayAtOffset').on('click', function() {
  create(5);
  play();
});

$('#initCreatePlayDelayedPlay').on('click', function() {
  init();
  create();
  play();
  setTimeout(function() {
    console.log('starting delayed play');

    prepare();
    console.log('swapping');
    var oldActive = active;
    active = preparing;
    preparing = oldActive;
    play();
    
  }, 4000);

});

function pause() {
  console.log('pausing');
  active.pause();
  fading.pause();
}

$('#init').on('click', function() {
  init();
});

$('#initAndPrepare').on('click', function() {
  init();

  prepare();
});

$('#initAndDelayedPrepare').on('click', function() {
  init();

  setTimeout(function() {
    prepare();
  }, 2000);
});

$('#prepare').on('click', function() {
  prepare();
});

$('#create').on('click', function() {
  create();
});

$('#initCreatePlay').on('click', function() {
  initCreatePlay();
});

$('#initCreatePlayPause').on('click', function() {
  initCreatePlay();
  active.pause();
});

$('#pause').on('click', function() {
  pause();
});

$('#play').on('click', function() {
  play();
});

</script>

</body>
</html>
