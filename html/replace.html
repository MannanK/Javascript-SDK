<html>
<body>
<script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
<script src="../node_modules/soundmanager2/script/soundmanager2.js" type="application/javascript"></script>
<script>


/*

  iOS Safari requires us to re-use the same <audio> tag that we create when
  we first start audio. This is done by passing the same id to the createSound
  method in SoundManager. 

  Other things:
    - To reassign the URL to the sound object, I've got to pass that in to the sound.play() method
      rather than just assigning it to the sound.url.
    - When advancing to a new sound object, I can't do the 'play()' in the stop 
      or finish handlers - I've got to do it after a setTimeout() that I kick off in those handlers.

*/

function ready() {
  $(function() {
    $('button').on('click', function() {
      var sound = soundManager.createSound({
        id: 'sound',
        url: 'https://feed.fm/js/latest/5seconds.m4a',
        type: 'audio/m4a',
        multiShot: false,
        onload: function(success) {
          console.log(sound.id + ': onload ' + sound.url, success);
          if (!success) {
            console.log(sound.id + ' failure! ' + sound.url);
          }
        },
        onstop: function() {
          console.log('5seconds stop called');
          sound.play({
            position: 0,
            url: 'https://dgase5ckewowv.cloudfront.net/feedfm-audio/1523037427-09079.m4a',
            onstop: function() {
              console.log('079 stopped');
              setTimeout(function() {
                sound.play({
                  position: 0,
                  url: 'https://dgase5ckewowv.cloudfront.net/feedfm-audio/1522977864-72616.m4a'
                });
              }, 1);
            },
            onfinish: function() {
              console.log('079 finished');
            }
          });
        },
        onfinish: function() {
          console.log(sound.url + ' finished!');
        }
      });

      sound.play();

      //createSong('one', 'https://dgase5ckewowv.cloudfront.net/feedfm-audio/1522977864-72616.m4a');
      setTimeout(function() {
        console.log('stopping');
        sound.stop();
        console.log('done with stop');
      }, 20000);

    });
  });
}

/*

To start playback at a particular offset, I've got to:
  - 'load' the play, rather than 'play' it on creation 
  - while the play is loading, look at the 'duration' of the song.
    when the 'duration' is >= our start offset, then we can start
    playing the song.
*/

function createSong(id, url) {

  // create a song, and start playback halfway into it
  var sound = soundManager.createSound({
    id: id,
    url: url,
    type: 'audio/m4a',
    onload: function(success) {
      console.log(sound.id + ': onload', success);
      if (!success) {
        console.log(sound.id + ' failure!');
      }
    },
    onfinish: function() {
      console.log('finished!');
    }
  });

  sound.play();
}


var config = {
  wmode: 'transparent',
  useHighPerformance: true,
  flashPollingInterval: 500,
  html5PollingInterval: 500,
  debugMode: true, 
  debugFlash: true,
  preferFlash: false,
  url: 'http://feed.fm/js/latest',
  onready:  ready
};

soundManager.setup(config);

</script>

<button>click me!</button>

</body>
</html>
